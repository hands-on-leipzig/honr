name: Deploy to PRD

on:
  workflow_dispatch:  # Manual trigger only for safety
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Confirm deployment
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "âŒ Deployment cancelled. You must type 'deploy' to confirm."
            exit 1
          fi
          echo "âœ… Production deployment confirmed"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.PRD_API_URL }}
        run: |
          npm ci
          npm run build-only

      - name: Copy frontend dist to backend public
        run: |
          mkdir -p backend/public
          rm -rf backend/public/build
          rm -f backend/public/index.html
          cp -r frontend/dist/* backend/public/

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.PRD_SSH_KEY }}
          SSH_USER: ${{ secrets.PRD_USER }}
          SSH_HOST: ${{ secrets.PRD_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH key - use printf to preserve newlines properly
          printf '%s\n' "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Verify key format
          echo "ðŸ” Verifying SSH key format..."
          if head -1 ~/.ssh/id_rsa | grep -q "BEGIN"; then
            echo "âœ… Key starts with BEGIN"
          else
            echo "âŒ Key is missing BEGIN line - check GitHub secret format"
            head -1 ~/.ssh/id_rsa
            exit 1
          fi
          if tail -1 ~/.ssh/id_rsa | grep -q "END"; then
            echo "âœ… Key ends with END"
          else
            echo "âŒ Key is missing END line - check GitHub secret format"
            tail -1 ~/.ssh/id_rsa
            exit 1
          fi
          # Extract and show public key fingerprint for verification
          echo "ðŸ” Extracting public key fingerprint..."
          ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub 2>&1 || {
            echo "âŒ Failed to extract public key - key format is invalid"
            echo "First 3 lines of key:"
            head -3 ~/.ssh/id_rsa
            exit 1
          }
          echo "Public key fingerprint:"
          ssh-keygen -lf ~/.ssh/id_rsa.pub || true
          # Scan for all host keys (RSA, ED25519, ECDSA) and add to known_hosts
          echo "ðŸ” Scanning host keys for $SSH_HOST..."
          ssh-keyscan -H -t rsa,ed25519,ecdsa $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          # Verify known_hosts was written
          echo "ðŸ” Known hosts file:"
          cat ~/.ssh/known_hosts
          # Test SSH connection with verbose output for debugging
          echo "ðŸ” Testing SSH connection..."
          ssh -v -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -o BatchMode=yes $SSH_USER@$SSH_HOST echo "SSH test successful" 2>&1 || {
            echo "âŒ SSH test failed"
            echo "Key file first line:"
            head -1 ~/.ssh/id_rsa
            echo "Key file last line:"
            tail -1 ~/.ssh/id_rsa
            echo "Key file line count:"
            wc -l ~/.ssh/id_rsa
            exit 1
          }

      - name: Rsync backend to server
        env:
          SSH_KEY: ${{ secrets.PRD_SSH_KEY }}
          SSH_USER: ${{ secrets.PRD_USER }}
          SSH_HOST: ${{ secrets.PRD_HOST }}
        run: |
          # Create temp directory structure on server
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts $SSH_USER@$SSH_HOST "mkdir -p ${{ secrets.PRD_DEPLOY_PATH }}/releases/temp/backend"
          # Rsync backend files to temp/backend directory
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts" --delete \
            --exclude='.env' \
            --exclude='.git' \
            --exclude='vendor' \
            --exclude='node_modules' \
            --exclude='tests' \
            ./backend/ $SSH_USER@$SSH_HOST:${{ secrets.PRD_DEPLOY_PATH }}/releases/temp/backend/

      - name: Finalize deployment on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRD_HOST }}
          username: ${{ secrets.PRD_USER }}
          key: ${{ secrets.PRD_SSH_KEY }}
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.PRD_DEPLOY_PATH }}"
            RELEASE_DIR="$DEPLOY_PATH/releases/$(date +%Y%m%d%H%M%S)"
            SHARED_DIR="$DEPLOY_PATH/shared"
            CURRENT_LINK="$DEPLOY_PATH/current"
            TEMP_DIR="$DEPLOY_PATH/releases/temp"
            
            echo "ðŸš€ Starting PRD deployment..."
            echo "Release directory: $RELEASE_DIR"
            
            # Create release directory
            mkdir -p "$RELEASE_DIR"
            
            # Move backend from temp to release directory
            if [ -d "$TEMP_DIR/backend" ]; then
              mv "$TEMP_DIR/backend" "$RELEASE_DIR/"
            else
              echo "âŒ Error: Backend files not found in $TEMP_DIR/backend"
              exit 1
            fi
            
            # Ensure shared directories exist
            mkdir -p "$SHARED_DIR/storage/app/public"
            mkdir -p "$SHARED_DIR/storage/framework/cache"
            mkdir -p "$SHARED_DIR/storage/framework/sessions"
            mkdir -p "$SHARED_DIR/storage/framework/views"
            mkdir -p "$SHARED_DIR/storage/logs"
            mkdir -p "$SHARED_DIR/bootstrap/cache"
            
            # Install Composer dependencies
            cd "$RELEASE_DIR/backend"
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Link shared storage
            rm -rf storage bootstrap/cache
            ln -sf "$SHARED_DIR/storage" storage
            ln -sf "$SHARED_DIR/bootstrap/cache" bootstrap/cache
            
            # Copy env file
            if [ -f "$SHARED_DIR/.env.prd" ]; then
              cp "$SHARED_DIR/.env.prd" .env
            else
              echo "âš ï¸  Warning: .env.prd not found in $SHARED_DIR"
            fi
            
            # Set permissions
            chmod -R 775 "$SHARED_DIR/storage" || true
            chmod -R 775 "$SHARED_DIR/bootstrap/cache" || true
            chown -R www-data:www-data "$SHARED_DIR/storage" || true
            chown -R www-data:www-data "$SHARED_DIR/bootstrap/cache" || true
            
            # Laravel setup
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan storage:link || true
            
            # Migrations (skip on initial deployment)
            echo "ðŸ“Š Checking database migration status..."
            MIGRATIONS_EXIST=$(php artisan tinker --execute="try { DB::table('migrations')->count(); echo 'true'; } catch (Exception \$e) { echo 'false'; }" 2>/dev/null | tail -1 || echo "false")
            
            if [ "$MIGRATIONS_EXIST" = "true" ]; then
              echo "ðŸ“Š Running database migrations..."
              php artisan migrate --force
            else
              echo "âš ï¸  Skipping migrations (initial deployment or migrations table not found)"
            fi
            
            # Clear and cache config
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan config:cache || true
            
            # Create symlink to current release
            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"
            
            # Cleanup temp directory
            rm -rf "$TEMP_DIR"
            
            # Clean up old releases (keep last 5)
            cd "$DEPLOY_PATH/releases"
            ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || true
            
            echo "âœ… PRD deployment completed!"
            echo "Current release: $RELEASE_DIR"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ PRD Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Code deployed to PRD server" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify application at: ${{ secrets.PRD_API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor logs for any issues" >> $GITHUB_STEP_SUMMARY

