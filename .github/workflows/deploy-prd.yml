name: Deploy to PRD

on:
  workflow_dispatch:  # Manual trigger only for safety
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Confirm deployment
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "âŒ Deployment cancelled. You must type 'deploy' to confirm."
            exit 1
          fi
          echo "âœ… Production deployment confirmed"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.PRD_API_URL }}
        run: |
          npm ci
          npm run build-only

      - name: Create deployment package
        run: |
          mkdir -p deploy-prd
          cp -r backend deploy-prd/
          cp -r frontend/dist deploy-prd/frontend-dist
          # Exclude unnecessary files
          rm -rf deploy-prd/backend/vendor
          rm -rf deploy-prd/backend/node_modules
          rm -rf deploy-prd/backend/tests
          rm -rf deploy-prd/backend/.git
          tar -czf deploy-prd.tar.gz deploy-prd/

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: prd-deployment
          path: deploy-prd.tar.gz
          retention-days: 30

      - name: Deploy to PRD server
        env:
          PRD_HOST: ${{ secrets.PRD_HOST }}
          PRD_USER: ${{ secrets.PRD_USER }}
          PRD_SSH_KEY: ${{ secrets.PRD_SSH_KEY }}
          PRD_DEPLOY_PATH: ${{ secrets.PRD_DEPLOY_PATH }}
        run: |
          echo "$PRD_SSH_KEY" > deploy_key
          chmod 600 deploy_key
          ssh -i deploy_key -o StrictHostKeyChecking=no $PRD_USER@$PRD_HOST << 'EOF'
            # Create deployment directory
            mkdir -p $PRD_DEPLOY_PATH/releases/$(date +%Y%m%d%H%M%S)
            RELEASE_DIR="$PRD_DEPLOY_PATH/releases/$(date +%Y%m%d%H%M%S)"
            
            # Extract deployment package
            cd $RELEASE_DIR
            # Note: You'll need to transfer the artifact first or use a different method
            # This is a template - adjust based on your hosting setup
          EOF
          rm -f deploy_key

      - name: Deployment summary
        run: |
          echo "## ðŸš€ PRD Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployment package created" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the deployment artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to PRD server" >> $GITHUB_STEP_SUMMARY
          echo "3. Run deployment script on server" >> $GITHUB_STEP_SUMMARY

