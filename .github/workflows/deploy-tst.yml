name: Deploy to TST

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.TST_API_URL }}
        run: |
          npm ci
          npm run build-only

      - name: Copy frontend dist to backend public
        run: |
          rm -rf backend/public/build
          rm -f backend/public/index.html
          cp -r frontend/dist/* backend/public/

      - name: Rsync backend to server
        env:
          SSH_KNOWN_HOST: ${{ secrets.SSH_KNOWN_HOST }}
          SSH_KEY: ${{ secrets.TST_SSH_KEY }}
          SSH_USER: ${{ secrets.TST_USER }}
          SSH_HOST: ${{ secrets.TST_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write known_hosts - should already have hostname (from ssh-keyscan without -H)
          echo "$SSH_KNOWN_HOST" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          # Verify known_hosts was written
          echo "ðŸ” Known hosts file:"
          cat ~/.ssh/known_hosts
          # Write SSH key
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Test SSH connection first
          echo "ðŸ” Testing SSH connection..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts $SSH_USER@$SSH_HOST echo "SSH test successful" || {
            echo "âŒ SSH test failed"
            echo "Known hosts content:"
            cat ~/.ssh/known_hosts
            exit 1
          }
          # Rsync with explicit known_hosts file
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts" --delete \
            --exclude='.env' \
            --exclude='.git' \
            --exclude='vendor' \
            --exclude='node_modules' \
            --exclude='tests' \
            ./backend/ $SSH_USER@$SSH_HOST:${{ secrets.TST_DEPLOY_PATH }}/releases/temp/

      - name: Finalize deployment on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TST_HOST }}
          username: ${{ secrets.TST_USER }}
          key: ${{ secrets.TST_SSH_KEY }}
          script: |
            cd ${{ secrets.TST_DEPLOY_PATH }}/releases/temp
            chmod +x scripts/deploy-backend.sh || true
            bash scripts/deploy-backend.sh tst ${{ secrets.TST_DEPLOY_PATH }} || {
              echo "âš ï¸  deploy-backend.sh not found or failed, running manual deployment..."
              # Manual deployment steps
              RELEASE_DIR="${{ secrets.TST_DEPLOY_PATH }}/releases/$(date +%Y%m%d%H%M%S)"
              mkdir -p "$RELEASE_DIR"
              mv * "$RELEASE_DIR/" 2>/dev/null || cp -r . "$RELEASE_DIR/"
              cd "$RELEASE_DIR"
              
              # Install dependencies
              composer install --no-dev --optimize-autoloader --no-interaction
              
              # Link shared storage
              ln -sf "${{ secrets.TST_DEPLOY_PATH }}/shared/storage" storage
              ln -sf "${{ secrets.TST_DEPLOY_PATH }}/shared/bootstrap/cache" bootstrap/cache
              
              # Copy env file
              if [ -f "${{ secrets.TST_DEPLOY_PATH }}/shared/.env.tst" ]; then
                cp "${{ secrets.TST_DEPLOY_PATH }}/shared/.env.tst" .env
              fi
              
              # Laravel setup
              php artisan config:cache || true
              php artisan route:cache || true
              php artisan view:cache || true
              php artisan storage:link || true
              
              # Migrations (skip on initial deployment)
              MIGRATIONS_EXIST=$(php artisan tinker --execute="try { DB::table('migrations')->count(); echo 'true'; } catch (Exception \$e) { echo 'false'; }" 2>/dev/null | tail -1 || echo "false")
              if [ "$MIGRATIONS_EXIST" = "true" ]; then
                php artisan migrate --force
              else
                echo "âš ï¸  Skipping migrations (initial deployment)"
              fi
              
              # Create symlink
              ln -sfn "$RELEASE_DIR" "${{ secrets.TST_DEPLOY_PATH }}/current"
              
              # Cleanup
              rm -rf "${{ secrets.TST_DEPLOY_PATH }}/releases/temp"
            }

      - name: Deployment summary
        run: |
          echo "## ðŸš€ TST Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Code deployed to TST server" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify application at: ${{ secrets.TST_API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Copy database from DEV to TST (if initial deployment)" >> $GITHUB_STEP_SUMMARY

