name: Build for TST

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build TST Deployment Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.TST_API_URL }}
        run: |
          npm ci
          npm run build-only

      - name: Create deployment package
        run: |
          mkdir -p deploy-tst
          cp -r backend deploy-tst/
          cp -r frontend/dist deploy-tst/frontend-dist
          cp -r scripts deploy-tst/
          # Exclude unnecessary files
          rm -rf deploy-tst/backend/vendor
          rm -rf deploy-tst/backend/node_modules
          rm -rf deploy-tst/backend/tests
          rm -rf deploy-tst/backend/.git
          tar -czf deploy-tst.tar.gz deploy-tst/

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: tst-deployment
          path: deploy-tst.tar.gz
          retention-days: 7

      - name: Build summary
        run: |
          echo "## ðŸš€ TST Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Build package created" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Server-side deployment:** Run on TST server:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd /var/www/honr" >> $GITHUB_STEP_SUMMARY
          echo "bash scripts/deploy-from-git.sh tst /var/www/honr main" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See \`SERVER_SIDE_DEPLOYMENT.md\` for details." >> $GITHUB_STEP_SUMMARY

