name: Deploy to TST

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.TST_API_URL }}
        run: |
          npm ci
          npm run build-only

      - name: Create deployment package
        run: |
          mkdir -p deploy-tst
          cp -r backend deploy-tst/
          cp -r frontend/dist deploy-tst/frontend-dist
          cp -r scripts deploy-tst/
          # Exclude unnecessary files
          rm -rf deploy-tst/backend/vendor
          rm -rf deploy-tst/backend/node_modules
          rm -rf deploy-tst/backend/tests
          rm -rf deploy-tst/backend/.git
          tar -czf deploy-tst.tar.gz deploy-tst/

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: tst-deployment
          path: deploy-tst.tar.gz
          retention-days: 7

      - name: Deploy to TST server
        env:
          TST_HOST: ${{ secrets.TST_HOST }}
          TST_USER: ${{ secrets.TST_USER }}
          TST_SSH_KEY: ${{ secrets.TST_SSH_KEY }}
          TST_DEPLOY_PATH: ${{ secrets.TST_DEPLOY_PATH }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH key, ensuring proper format (no CRLF, proper newlines)
          # Remove carriage returns and ensure proper line endings
          echo "$TST_SSH_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Add server to known hosts
          ssh-keyscan -H $TST_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Debug: Check key format (first and last lines only)
          echo "ğŸ” Checking SSH key format..."
          echo "First line: $(head -1 ~/.ssh/deploy_key | cut -c1-30)..."
          echo "Last line: $(tail -1 ~/.ssh/deploy_key | cut -c1-30)..."
          echo "Key file size: $(wc -c < ~/.ssh/deploy_key) bytes"
          
          # Test SSH connection with verbose output
          echo "ğŸ” Testing SSH connection..."
          ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes $TST_USER@$TST_HOST echo "SSH test successful" 2>&1 | head -20 || echo "SSH test failed (this is expected if key is not authorized)"
          
          # Transfer deployment package
          echo "ğŸ“¤ Transferring deployment package to server..."
          scp -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes deploy-tst.tar.gz $TST_USER@$TST_HOST:/tmp/ 2>&1 | head -30
          
          # Deploy on server
          echo "ğŸš€ Deploying on server..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $TST_USER@$TST_HOST << EOF
            set -e
            
            # Create deployment directory structure if it doesn't exist
            mkdir -p $TST_DEPLOY_PATH/releases
            mkdir -p $TST_DEPLOY_PATH/shared/storage/{app/public,framework/{cache,sessions,views},logs}
            mkdir -p $TST_DEPLOY_PATH/shared/bootstrap/cache
            
            # Extract deployment package
            cd /tmp
            tar -xzf deploy-tst.tar.gz
            
            # Move files to release directory
            RELEASE_DIR="$TST_DEPLOY_PATH/releases/\$(date +%Y%m%d%H%M%S)"
            mkdir -p "\$RELEASE_DIR"
            mv deploy-tst/* "\$RELEASE_DIR/"
            
            # Install Composer dependencies
            echo "ğŸ“¦ Installing Composer dependencies..."
            cd "\$RELEASE_DIR/backend"
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Link shared storage
            ln -sf "$TST_DEPLOY_PATH/shared/storage" "\$RELEASE_DIR/backend/storage"
            ln -sf "$TST_DEPLOY_PATH/shared/bootstrap/cache" "\$RELEASE_DIR/backend/bootstrap/cache"
            
            # Copy environment file if it exists, otherwise create from example
            if [ -f "$TST_DEPLOY_PATH/shared/.env.tst" ]; then
              cp "$TST_DEPLOY_PATH/shared/.env.tst" "\$RELEASE_DIR/backend/.env"
            elif [ -f "\$RELEASE_DIR/backend/env.tst.example" ]; then
              cp "\$RELEASE_DIR/backend/env.tst.example" "\$RELEASE_DIR/backend/.env"
              echo "âš ï¸  Using example .env file. Please configure it properly!"
            fi
            
            # Set permissions
            chmod -R 775 "$TST_DEPLOY_PATH/shared/storage" || true
            chmod -R 775 "$TST_DEPLOY_PATH/shared/bootstrap/cache" || true
            
            # Run Laravel setup commands
            echo "âš™ï¸  Running Laravel setup..."
            cd "\$RELEASE_DIR/backend"
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan storage:link || true
            
            # Check if migrations table exists (skip migrations on initial deployment)
            echo "ğŸ“Š Checking database migration status..."
            MIGRATIONS_EXIST=\$(php artisan tinker --execute="try { DB::table('migrations')->count(); echo 'true'; } catch (Exception \$e) { echo 'false'; }" 2>/dev/null | tail -1 || echo "false")
            
            if [ "\$MIGRATIONS_EXIST" = "true" ]; then
              echo "ğŸ“Š Running database migrations..."
              php artisan migrate --force
            else
              echo "âš ï¸  Migrations table not found. Skipping migrations (initial deployment)."
              echo "âš ï¸  Database should be copied from DEV separately."
            fi
            
            # Clear and cache config
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan config:cache || true
            
            # Create symlink to current release
            ln -sfn "\$RELEASE_DIR" "$TST_DEPLOY_PATH/current"
            
            # Clean up
            rm -rf /tmp/deploy-tst /tmp/deploy-tst.tar.gz
            
            echo "âœ… Deployment completed!"
            echo "Release directory: \$RELEASE_DIR"
          EOF
          
          # Clean up
          rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        run: |
          echo "## ğŸš€ TST Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Code deployed to TST server" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify application at: ${{ secrets.TST_API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Copy database from DEV to TST (if initial deployment)" >> $GITHUB_STEP_SUMMARY

