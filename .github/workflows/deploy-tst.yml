name: Deploy to TST

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.TST_API_URL }}
        run: |
          npm ci
          npm run build-only

      - name: Copy frontend dist to backend public
        run: |
          mkdir -p backend/public
          rm -rf backend/public/build
          rm -f backend/public/index.html
          cp -r frontend/dist/* backend/public/

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.TST_SSH_KEY }}
          SSH_USER: ${{ secrets.TST_USER }}
          SSH_HOST: ${{ secrets.TST_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH key - handle different formats
          # Remove any leading/trailing whitespace and ensure proper newlines
          echo "$SSH_KEY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Verify key format
          echo "üîç Verifying SSH key format..."
          KEY_START=$(head -1 ~/.ssh/id_rsa)
          KEY_END=$(tail -1 ~/.ssh/id_rsa)
          
          if echo "$KEY_START" | grep -qE "(BEGIN|OPENSSH)"; then
            echo "‚úÖ Key starts with: $KEY_START"
          else
            echo "‚ùå Key is missing BEGIN marker - check GitHub secret format"
            echo "First line: $KEY_START"
            exit 1
          fi
          
          if echo "$KEY_END" | grep -qE "(END|PRIVATE)"; then
            echo "‚úÖ Key ends with: $KEY_END"
          else
            echo "‚ùå Key is missing END marker - check GitHub secret format"
            echo "Last line: $KEY_END"
            exit 1
          fi
          
          # Detect key type
          if echo "$KEY_START" | grep -q "OPENSSH"; then
            KEY_TYPE="openssh"
            echo "üîç Detected OpenSSH format key"
          elif echo "$KEY_START" | grep -q "RSA"; then
            KEY_TYPE="rsa"
            echo "üîç Detected RSA PEM format key"
          elif echo "$KEY_START" | grep -q "EC"; then
            KEY_TYPE="ec"
            echo "üîç Detected EC PEM format key"
          else
            KEY_TYPE="unknown"
            echo "‚ö†Ô∏è  Unknown key format, will try to use as-is"
          fi
          
          # Try to extract public key for verification (optional - SSH can work without it)
          echo "üîç Attempting to extract public key fingerprint..."
          if ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub 2>/dev/null; then
            echo "‚úÖ Public key extracted successfully"
            echo "Public key fingerprint:"
            ssh-keygen -lf ~/.ssh/id_rsa.pub 2>/dev/null || true
          else
            echo "‚ö†Ô∏è  Could not extract public key (this is OK - SSH can use private key directly)"
            echo "‚ö†Ô∏è  Possible reasons:"
            echo "   - Key is encrypted with passphrase (will fail during connection)"
            echo "   - Key format issue (but may still work)"
            echo "   - Will attempt connection anyway with private key"
            echo ""
            echo "Key info:"
            echo "  - Line count: $(wc -l < ~/.ssh/id_rsa)"
            echo "  - First line: $(head -1 ~/.ssh/id_rsa)"
            echo "  - Last line: $(tail -1 ~/.ssh/id_rsa)"
            # Don't exit - try to use the key directly
          fi
          # Scan for all host keys (RSA, ED25519, ECDSA) and add to known_hosts
          echo "üîç Scanning host keys for $SSH_HOST..."
          ssh-keyscan -H -t rsa,ed25519,ecdsa $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          # Verify known_hosts was written
          echo "üîç Known hosts file:"
          cat ~/.ssh/known_hosts
          # Test SSH connection with verbose output for debugging
          echo "üîç Testing SSH connection..."
          ssh -v -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -o BatchMode=yes $SSH_USER@$SSH_HOST echo "SSH test successful" 2>&1 || {
            echo "‚ùå SSH test failed"
            echo "Key file first line:"
            head -1 ~/.ssh/id_rsa
            echo "Key file last line:"
            tail -1 ~/.ssh/id_rsa
            echo "Key file line count:"
            wc -l ~/.ssh/id_rsa
            exit 1
          }

      - name: Rsync backend to server
        env:
          SSH_KEY: ${{ secrets.TST_SSH_KEY }}
          SSH_USER: ${{ secrets.TST_USER }}
          SSH_HOST: ${{ secrets.TST_HOST }}
        run: |
          # Create temp directory structure on server
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts $SSH_USER@$SSH_HOST "mkdir -p ${{ secrets.TST_DEPLOY_PATH }}/releases/temp/backend"
          # Rsync backend files to temp/backend directory
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts" --delete \
            --exclude='.env' \
            --exclude='.git' \
            --exclude='vendor' \
            --exclude='node_modules' \
            --exclude='tests' \
            ./backend/ $SSH_USER@$SSH_HOST:${{ secrets.TST_DEPLOY_PATH }}/releases/temp/backend/

      - name: Finalize deployment on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TST_HOST }}
          username: ${{ secrets.TST_USER }}
          key: ${{ secrets.TST_SSH_KEY }}
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.TST_DEPLOY_PATH }}"
            RELEASE_DIR="$DEPLOY_PATH/releases/$(date +%Y%m%d%H%M%S)"
            SHARED_DIR="$DEPLOY_PATH/shared"
            CURRENT_LINK="$DEPLOY_PATH/current"
            TEMP_DIR="$DEPLOY_PATH/releases/temp"
            
            echo "üöÄ Starting deployment..."
            echo "Release directory: $RELEASE_DIR"
            
            # Create release directory
            mkdir -p "$RELEASE_DIR"
            
            # Move backend from temp to release directory
            if [ -d "$TEMP_DIR/backend" ]; then
              mv "$TEMP_DIR/backend" "$RELEASE_DIR/"
            else
              echo "‚ùå Error: Backend files not found in $TEMP_DIR/backend"
              exit 1
            fi
            
            # Ensure shared directories exist
            mkdir -p "$SHARED_DIR/storage/app/public"
            mkdir -p "$SHARED_DIR/storage/framework/cache"
            mkdir -p "$SHARED_DIR/storage/framework/sessions"
            mkdir -p "$SHARED_DIR/storage/framework/views"
            mkdir -p "$SHARED_DIR/storage/logs"
            mkdir -p "$SHARED_DIR/bootstrap/cache"
            
            # Install Composer dependencies
            cd "$RELEASE_DIR/backend"
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Link shared storage
            rm -rf storage bootstrap/cache
            ln -sf "$SHARED_DIR/storage" storage
            ln -sf "$SHARED_DIR/bootstrap/cache" bootstrap/cache
            
            # Copy env file
            if [ -f "$SHARED_DIR/.env.tst" ]; then
              cp "$SHARED_DIR/.env.tst" .env
            else
              echo "‚ö†Ô∏è  Warning: .env.tst not found in $SHARED_DIR"
            fi
            
            # Set permissions
            chmod -R 775 "$SHARED_DIR/storage" || true
            chmod -R 775 "$SHARED_DIR/bootstrap/cache" || true
            chown -R www-data:www-data "$SHARED_DIR/storage" || true
            chown -R www-data:www-data "$SHARED_DIR/bootstrap/cache" || true
            
            # Laravel setup
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan storage:link || true
            
            # Migrations (skip on initial deployment)
            echo "üìä Checking database migration status..."
            MIGRATIONS_EXIST=$(php artisan tinker --execute="try { DB::table('migrations')->count(); echo 'true'; } catch (Exception \$e) { echo 'false'; }" 2>/dev/null | tail -1 || echo "false")
            
            if [ "$MIGRATIONS_EXIST" = "true" ]; then
              echo "üìä Running database migrations..."
              php artisan migrate --force
            else
              echo "‚ö†Ô∏è  Skipping migrations (initial deployment or migrations table not found)"
            fi
            
            # Clear and cache config
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan config:cache || true
            
            # Create symlink to current release
            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"
            
            # Cleanup temp directory
            rm -rf "$TEMP_DIR"
            
            # Clean up old releases (keep last 5)
            cd "$DEPLOY_PATH/releases"
            ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || true
            
            echo "‚úÖ Deployment completed!"
            echo "Current release: $RELEASE_DIR"

      - name: Deployment summary
        run: |
          echo "## üöÄ TST Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ‚úÖ Code deployed to TST server" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify application at: ${{ secrets.TST_API_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Copy database from DEV to TST (if initial deployment)" >> $GITHUB_STEP_SUMMARY

