name: Deploy Application (Reusable)

on:
  workflow_call:
    inputs:
      checkout_ref:
        required: true
        type: string
      app_url:
        required: true
        type: string
      temp_dir:
        required: true
        type: string
      public_dir:
        required: true
        type: string
      refresh_m_tables:
        required: true
        type: boolean
      fix_migration_records:
        required: true
        type: boolean
      verify_migrations:
        required: true
        type: boolean
      seed_main_data:
        required: true
        type: boolean
      environment_name:
        required: false
        type: string
        default: 'unknown'
    secrets:
      SSH_KNOWN_HOST:
        required: true
      SSH_KEY:
        required: true
      SSH_USER:
        required: true
      SSH_HOST:
        required: true
      API_BASE_URL:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Environment protection is applied here for production deployments
    environment: ${{ inputs.environment_name == 'production' && 'production' || '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.checkout_ref }}

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Create frontend .env file
        working-directory: ./frontend
        run: |
          echo "VITE_API_URL=${{ secrets.API_BASE_URL }}" > .env
          echo "VITE_APP_NAME=HONR" >> .env
          echo "VITE_APP_URL=${{ inputs.app_url }}" >> .env
          echo "VITE_FILES_BASE_URL=${{ inputs.app_url }}" >> .env

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build-only
        env:
          NODE_ENV: production

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_mysql, mbstring, xml, curl, zip, gd
          coverage: none

      - name: Install Laravel dependencies
        working-directory: ./backend
        run: composer install --optimize-autoloader

      - name: Run backend tests
        working-directory: ./backend
        continue-on-error: true
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
            echo "ðŸ§ª Running backend tests..."
            php artisan test || {
              echo "âš ï¸  WARNING: Some tests failed, but continuing deployment..."
              echo "Review test failures above and fix before next deployment."
            }
          else
            echo "â„¹ï¸  No tests found, skipping test execution"
          fi

      - name: Run frontend tests
        working-directory: ./frontend
        continue-on-error: true
        run: |
          if npm run | grep -q "test"; then
            echo "ðŸ§ª Running frontend tests..."
            npm test -- --run || {
              echo "âš ï¸  WARNING: Some frontend tests failed, but continuing deployment..."
              echo "Review test failures above and fix before next deployment."
            }
          else
            echo "â„¹ï¸  No test script found in package.json, skipping frontend tests"
          fi

      - name: Copy frontend dist to Laravel public dir
        run: |
          rm -rf backend/public/build
          rm -f backend/public/index.html
          cp -r frontend/dist/* backend/public/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOST }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Verify key format
          echo "ðŸ” Verifying SSH key..."
          if head -1 ~/.ssh/id_rsa | grep -qE "(BEGIN|OPENSSH)"; then
            echo "âœ… Key format looks correct"
          else
            echo "âŒ Key format issue - first line: $(head -1 ~/.ssh/id_rsa)"
            exit 1
          fi
          
          # Try to extract public key for verification
          if ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub 2>/dev/null; then
            echo "âœ… Public key extracted successfully"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“‹ PUBLIC KEY (add this to server's ~/.ssh/authorized_keys on port 222):"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat ~/.ssh/id_rsa.pub
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ðŸ”‘ Public key fingerprint:"
            ssh-keygen -lf ~/.ssh/id_rsa.pub
            echo ""
          else
            echo "âš ï¸  Could not extract public key (key might be encrypted)"
            echo "You'll need to extract it manually: ssh-keygen -y -f /path/to/private/key"
          fi
          
          # Test SSH connection
          echo "ðŸ” Testing SSH connection to port 222..."
          ssh -v -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p 222 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} echo "SSH test successful" 2>&1 || {
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ SSH AUTHENTICATION FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "The public key above needs to be added to the server's authorized_keys file."
            echo ""
            echo "To fix this, SSH to the server (using a working key) and run:"
            echo "  mkdir -p ~/.ssh"
            echo "  chmod 700 ~/.ssh"
            echo "  echo 'PASTE_PUBLIC_KEY_HERE' >> ~/.ssh/authorized_keys"
            echo "  chmod 600 ~/.ssh/authorized_keys"
            echo ""
            echo "Or use ssh-copy-id (if you have password access):"
            echo "  ssh-copy-id -p 222 -i ~/.ssh/id_rsa.pub ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
            echo ""
            exit 1
          }

      - name: Rsync backend to server
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p 222" --delete ./backend/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/${{ inputs.temp_dir }}/

      - name: Verify deployment health
        run: |
          echo "ðŸ¥ Checking application health..."
          MAX_RETRIES=5
          RETRY_DELAY=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # Try /api/ping endpoint first
            if curl -f -s --max-time 10 "${{ inputs.app_url }}/api/ping" > /dev/null 2>&1; then
              echo "âœ… Health check passed! Application is responding at /api/ping"
              exit 0
            # Fallback: try Laravel's built-in /up endpoint
            elif curl -f -s --max-time 10 "${{ inputs.app_url }}/up" > /dev/null 2>&1; then
              echo "âœ… Health check passed! Application is responding at /up"
              exit 0
            # Fallback: try the frontend (index.html)
            elif curl -f -s --max-time 10 "${{ inputs.app_url }}" > /dev/null 2>&1; then
              echo "âœ… Application is responding (frontend loads)"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Health check failed (attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "Application may not be responding at ${{ inputs.app_url }}"
          echo ""
          echo "Debugging info:"
          echo "  - Tried URLs: ${{ inputs.app_url }}/api/ping, ${{ inputs.app_url }}/up, ${{ inputs.app_url }}"
          echo "  - Check if application is deployed and web server is running"
          echo "  - Verify the app_url is correct: ${{ inputs.app_url }}"
          echo "  - Check server logs for errors"
          echo ""
          echo "âš ï¸  Health check is MANDATORY - deployment failed!"
          exit 1

      - name: Notify deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ inputs.environment_name }}';
            const appUrl = '${{ inputs.app_url }}';
            const commitSha = context.sha.substring(0, 7);
            const commitMessage = context.payload.head_commit?.message || 'No commit message';
            const actor = context.actor;
            
            const message = `âœ… **Deployment Successful**
            
            **Environment:** ${environment}
            **URL:** ${appUrl}
            **Commit:** \`${commitSha}\`
            **Message:** ${commitMessage}
            **Deployed by:** @${actor}
            **Time:** ${new Date().toISOString()}
            
            Deployment completed and health check passed.`;
            
            // Create a deployment status comment or issue comment
            // For now, we'll log it - you can extend this to post to Slack, Discord, etc.
            console.log(message);
            
            // Optionally, you can create a deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              description: `Deployment to ${environment} completed successfully`,
              environment: environment
            }).catch(err => {
              // Deployment status creation is optional, don't fail if it doesn't work
              console.log('Note: Could not create deployment status (this is optional)');
            });

      - name: Notify deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ inputs.environment_name }}';
            const appUrl = '${{ inputs.app_url }}';
            const commitSha = context.sha.substring(0, 7);
            const actor = context.actor;
            const workflowRun = context.runId;
            const workflowUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${workflowRun}`;
            
            const message = `âŒ **Deployment Failed**
            
            **Environment:** ${environment}
            **URL:** ${appUrl}
            **Commit:** \`${commitSha}\`
            **Deployed by:** @${actor}
            **Time:** ${new Date().toISOString()}
            **Workflow Run:** ${workflowUrl}
            
            Please check the workflow logs for details.`;
            
            console.error(message);
            
            // Optionally create a deployment status
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'failure',
              description: `Deployment to ${environment} failed`,
              environment: environment
            }).catch(err => {
              console.log('Note: Could not create deployment status (this is optional)');
            });
